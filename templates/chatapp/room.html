{% extends 'base.html' %}
{% load static %}
{% load chat_extras %}

{% block title %}Chat - WebChat{% endblock %}

{% block extra_css %}
        <link rel="stylesheet" href="{% static 'css/room.css' %}">
{% endblock %}

{% block content %}
    <div class="chat-container">
        <!-- Left Sidebar - Contacts -->
        {% include "chatapp/common.html" with is_home_page=False active_chat_id=chat.id %}

        <!-- Right Side - Chat Area -->
        <div class="chat-area">
            <!-- Connection Status -->
            <div id="connectionStatus" class="connection-status connecting">Connecting...</div>

            <div class="chat-header">
                <a href="{% url 'chatapp:home' %}"
                   style="background: rgba(255,255,255,0.2); border: none; width: 36px; height: 36px; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); backdrop-filter: blur(10px); text-decoration: none; font-size: 16px; margin-right:4px;"
                   onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.1)'"
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'"
                >←</a>
                {% if chat.chat_type == 'private' %}
                    {% with other_user=chat|get_other_participant:current_user %}
                        {% if other_user %}
                            <div class="contact-avatar"
                                 style="background: {{ other_user.id|get_avatar_color }}; position: relative;">
                                {% if other_user.userprofile and other_user.userprofile.image %}
                                    <img src="{{ other_user.userprofile.image.url }}" alt="Avatar"
                                         style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"/>
                                {% else %}
                                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                        {{ other_user.userprofile.get_avatar_initials|default:other_user.username|slice:":2"|upper }}
                                    </div>
                                {% endif %}
                                {% if other_user.userprofile.is_online %}
                                    <div class="online-indicator"></div>
                                {% endif %}
                            </div>
                            <div class="chat-user-info">
                                <div class="chat-user-name">{{ other_user.get_full_name|default:other_user.username }}</div>
                                <div class="chat-user-status" id="userStatus">
                                    {% if other_user.userprofile.is_online %}
                                        Online
                                    {% else %}
                                        Last seen {{ other_user.userprofile.last_seen|timesince }} ago
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    {% endwith %}
                {% endif %}
                <div class="chat-actions" style="position: relative; display: flex; gap: 8px;">
                    <div class="search-container"
                         style="padding: 0; background: transparent; border-bottom: none; min-width: 230px;">
                        <div style="position: relative;">
                            <input type="text" class="search-box" placeholder="Search messages..." id="chatSearchInput">
                            <div id="chatSearchResults"
                                 style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--primary-color); border-top: none; border-radius: 0 0 8px 8px; max-height: 280px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 16px rgba(0,0,0,0.1);"></div>
                        </div>
                    </div>
                    <button class="action-btn" id="dropdownToggleBtn">⋮</button>
                    <div class="dropdown-menu" id="chatDropdownMenu" style="right: 0;">
                        <div class="dropdown-header">Chat Options</div>
                        <button class="dropdown-item">Mute Chat</button>
                        <button class="dropdown-item danger">Report User</button>
                    </div>
                </div>


            </div>

            <div class="messages-container" id="messagesContainer">
                {% for message in messages %}
                    <div class="message {% if message.sender == current_user %}sent{% else %}received{% endif %}"
                         data-timestamp="{{ message.timestamp.isoformat }}">
                        <div class="message-text">{{ message.content }}</div>
                        <div class="message-time">{{ message.timestamp|date:"g:i A" }}</div>
                    </div>
                {% endfor %}
            </div>

            <div class="typing-indicator" id="typingIndicator" style="display: none;"></div>

            <div class="message-input-container">
                <input type="text" class="message-input" placeholder="Type a message..." id="messageInput">
                <button class="send-btn" id="sendBtn" title="Send message"></button>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
    <script>
        chatId = {{chat.id}};
        const currentUser = '{{ current_user.username }}';
        const currentUserId = {{current_user.id}};
    </script>
    <script src="{% static 'js/room.js' %}"></script>
    <script src="{% static 'js/common.js' %}"></script>
{% endblock %}

