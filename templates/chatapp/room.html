{% extends 'base.html' %}
{% load static %}
{% load chat_extras %}

{% block title %}Chat - WebChat{% endblock %}

{% block extra_css %}
    <style>
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #efeae2 0%, #f5f1ec 100%);
            background-image: radial-gradient(circle at 20% 50%, rgba(0, 168, 132, 0.02) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(37, 211, 102, 0.02) 0%, transparent 50%);
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 16px 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0, 168, 132, 0.2);
        }

        .chat-user-info {
            flex: 1;
        }

        .chat-user-name {
            font-weight: 600;
            color: white;
            margin-bottom: 2px;
            font-size: 16px;
        }

        .chat-user-status {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .chat-actions {
            display: flex;
            gap: 8px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 65%;
            padding: 10px 14px;
            border-radius: 16px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--message-sent), #c8f7c5);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            align-self: flex-start;
            background: var(--message-received);
            margin-right: auto;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .message-text {
            margin-bottom: 6px;
            line-height: 1.4;
            font-size: 14px;
            color: var(--text-primary);
        }

        .message-time {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: right;
            font-weight: 500;
            opacity: 0.8;
        }

        .message-input-container {
            background: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.06);
            border-top: 1px solid var(--border-color);
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            outline: none;
            font-size: 14px;
            background: var(--background-color);
            transition: var(--transition);
            font-family: inherit;
        }

        .message-input:focus {
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 2px rgba(0, 168, 132, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(0, 168, 132, 0.3);
            position: relative;
            overflow: hidden;
        }

        .send-btn::before {
            content: '→';
            font-weight: bold;
            transition: var(--transition);
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 168, 132, 0.4);
        }

        .send-btn:hover::before {
            transform: translateX(2px);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .send-btn:disabled::before {
            content: '⋯';
            animation: loading 1s infinite;
        }

        @keyframes loading {
            0%, 20% {
                opacity: 0.2;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.2;
            }
        }

        .typing-indicator {
            padding: 12px 20px;
            font-style: italic;
            color: var(--text-secondary);
            font-size: 12px;
            background: rgba(255, 255, 255, 0.8);
            margin: 0 20px;
            border-radius: 8px;
            animation: pulse 1.5s infinite;
        }

        .connection-status {
            padding: 6px 12px;
            font-size: 11px;
            text-align: center;
            color: white;
            font-weight: 600;
            transition: var(--transition);
        }

        .connection-status.connected {
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
        }

        .connection-status.disconnected {
            background: linear-gradient(90deg, #ff6b6b, #ee5a24);
        }

        .connection-status.connecting {
            background: linear-gradient(90deg, #fdcb6e, #e17055);
        }

        .contact-item.active {
            background: rgba(0, 168, 132, 0.1);
            border-left: 3px solid var(--primary-color);
        }

        /* Fix for SAME header size: */
        .chat-header, .sidebar-header {
            height: 64px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0, 168, 132, 0.2);
        }

        @media (max-width: 768px) {
            .contacts-sidebar {
                display: none;
            }

            .message {
                max-width: 85%;
            }

            .messages-container {
                padding: 16px 12px;
            }

            .message-input-container {
                padding: 12px;
                gap: 8px;
            }

            .message-input {
                padding: 10px 14px;
                font-size: 13px;
            }

            .send-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .chat-header {
                padding: 12px 16px;
            }

            .chat-user-name {
                font-size: 15px;
            }

            .chat-user-status {
                font-size: 11px;
            }

            .sidebar-header,
            .chat-header {
                padding: 12px 16px;
                min-height: 48px;
                gap: 12px;
            }
        }

        @media (max-width: 480px) {
            .message {
                max-width: 90%;
                padding: 8px 12px;
            }

            .message-text {
                font-size: 13px;
            }

            .message-time {
                font-size: 9px;
            }

            .messages-container {
                padding: 12px 8px;
                gap: 8px;
            }

            .message-input-container {
                padding: 8px;
            }

            .send-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="chat-container">
        <!-- Left Sidebar - Contacts -->
        <div class="contacts-sidebar">
            <div class="sidebar-header">
                <div class="user-profile" style="display: flex; align-items: center; gap: 10px;">
                    {% with userprofile=current_user.userprofile %}
                        {% if userprofile.image %}
                            <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; background: #fff;">
                                <img src="{{ userprofile.image.url }}"
                                     alt="Profile Image"
                                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                            </div>
                        {% else %}
                            <div class="profile-pic"
                                 style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;">
                                {{ userprofile.get_avatar_initials }}
                            </div>
                        {% endif %}
                    {% endwith %}
                    <div>
                        <div style="font-weight: 600; font-size: 14px; color: white;">
                            {{ current_user.get_full_name|default:current_user.username }}
                        </div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.8);">
                            @{{ current_user.username }}
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="action-btn" onclick="toggleUserMenu()" title="Menu" id="menuBtn">⋮</button>
                </div>
            </div>
            <!-- User Menu Dropdown -->
            <div id="userMenu" class="dropdown-menu" style="top: 85px; right: 20px;">
                <div class="dropdown-header">
                    <div style="font-weight: 600; color: white;">{{ current_user.get_full_name|default:current_user.username }}</div>
                    <div style="font-size: 13px; color: rgba(255,255,255,0.8);">@{{ current_user.username }}</div>
                </div>
                <div style="padding: 8px 0;">
                    <a href="{% url 'account:profile' %}?next={{ request.path }}
" class="dropdown-item">
                        <span style="margin-right: 12px; font-size: 16px;">👤</span>
                        Profile Settings
                    </a>
                    <div style="border-top: 1px solid var(--border-color); margin: 6px 0;"></div>
                    <a href="{% url 'account:logout' %}" class="dropdown-item danger">
                        <span style="margin-right: 12px; font-size: 16px;">🚪</span>
                        Logout
                    </a>
                </div>
            </div>


            <div class="search-container">
                <div style="position: relative;">
                    <input type="text" class="search-box" placeholder="Search users to chat..." id="searchInput">
                    <div id="searchResults"
                         style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--primary-color); border-top: none; border-radius: 0 0 8px 8px; max-height: 280px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 16px rgba(0,0,0,0.1);"></div>
                </div>
            </div>

            <div class="contacts-list">
                {% for chat_item in chats %}
                    {% if chat_item.chat_type == 'private' %}
                        {% with other_user=chat_item|get_other_participant:current_user %}
                            {% if other_user %}
                                <a href="{% url 'chatapp:room' chat_item.id %}"
                                   class="contact-item {% if chat_item.id == active_chat_id %}active{% endif %}">
                                    <div class="contact-avatar"
                                         style="background: {{ other_user.id|get_avatar_color }}; position: relative; overflow: hidden; border-radius: 50%; width: 40px; height: 40px;">
                                        {% if other_user.userprofile and other_user.userprofile.image %}
                                            <img src="{{ other_user.userprofile.image.url }}" alt="Avatar"
                                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"/>
                                        {% else %}
                                            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                                {{ other_user.userprofile.get_avatar_initials|default:other_user.username|slice:":2"|upper }}
                                            </div>
                                        {% endif %}
                                        {% if other_user.userprofile.is_online %}
                                            <div class="online-indicator"></div>
                                        {% endif %}


                                    </div>
                                    <div class="contact-info">
                                        <div class="contact-name">{{ other_user.get_full_name|default:other_user.username }}</div>
                                        <div class="contact-last-message">
                                            {% with last_message=chat_item.get_last_message %}
                                                {% if last_message %}
                                                    {% if last_message.sender == current_user %}
                                                        You: {{ last_message.content|truncatechars:20 }}
                                                    {% else %}
                                                        {{ last_message.content|truncatechars:25 }}
                                                    {% endif %}
                                                {% else %}
                                                    No messages yet
                                                {% endif %}
                                            {% endwith %}
                                        </div>

                                    </div>
                                    <div class="contact-meta">
                                        {% with last_message=chat_item.get_last_message %}
                                            {% if last_message %}
                                                {% if last_message.timestamp.date == today %}
                                                    <div class="message-time">{{ last_message.timestamp|date:"g:i A" }}</div>
                                                {% else %}
                                                    <div class="message-time">{{ last_message.timestamp|format_message_time }}</div>
                                                {% endif %}
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                </a>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                {% endfor %}
                <a href="{% url 'chatapp:home' %}"
                   class="contact-item"
                   style="margin: 18px 0 0 0;display: flex;align-items: center;justify-content: center;gap: 8px;font-weight: 600;color: var(--primary-color);background: #fff;border-radius: 12px;">
                    <span style="font-size: 20px;"><-</span> Back to Home
                </a>

            </div>
        </div>

        <!-- Right Side - Chat Area -->
        <div class="chat-area">
            <!-- Connection Status -->
            <div id="connectionStatus" class="connection-status connecting">Connecting...</div>

            <div class="chat-header">
                <a href="{% url 'chatapp:home' %}"
                   style="background: rgba(255,255,255,0.2); border: none; width: 36px; height: 36px; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); backdrop-filter: blur(10px); text-decoration: none; font-size: 16px; margin-right:4px;"
                   onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.1)'"
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'"
                >←</a>
                {% if chat.chat_type == 'private' %}
                    {% with other_user=chat|get_other_participant:current_user %}
                        {% if other_user %}
                            <div class="contact-avatar"
                                 style="background: {{ other_user.id|get_avatar_color }}; position: relative;">
                                {% if other_user.userprofile and other_user.userprofile.image %}
                                    <img src="{{ other_user.userprofile.image.url }}" alt="Avatar"
                                         style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"/>
                                {% else %}
                                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                        {{ other_user.userprofile.get_avatar_initials|default:other_user.username|slice:":2"|upper }}
                                    </div>
                                {% endif %}
                                {% if other_user.userprofile.is_online %}
                                    <div class="online-indicator"></div>
                                {% endif %}
                            </div>
                            <div class="chat-user-info">
                                <div class="chat-user-name">{{ other_user.get_full_name|default:other_user.username }}</div>
                                <div class="chat-user-status" id="userStatus">
                                    {% if other_user.userprofile.is_online %}
                                        Online
                                    {% else %}
                                        Last seen {{ other_user.userprofile.last_seen|timesince }} ago
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    {% endwith %}
                {% endif %}
                <div class="chat-actions" style="position: relative; display: flex; gap: 8px;">
                    <div class="search-container"
                         style="padding: 0; background: transparent; border-bottom: none; min-width: 230px;">
                        <div style="position: relative;">
                            <input type="text" class="search-box" placeholder="Search messages..." id="chatSearchInput">
                            <div id="chatSearchResults"
                                 style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--primary-color); border-top: none; border-radius: 0 0 8px 8px; max-height: 280px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 16px rgba(0,0,0,0.1);"></div>
                        </div>
                    </div>
                    <button class="action-btn" id="dropdownToggleBtn">⋮</button>
                    <div class="dropdown-menu" id="chatDropdownMenu" style="right: 0;">
                        <div class="dropdown-header">Chat Options</div>
                        <button class="dropdown-item">Mute Chat</button>
                        <button class="dropdown-item danger">Report User</button>
                    </div>
                </div>


            </div>

            <div class="messages-container" id="messagesContainer">
                {% for message in messages %}
                    <div class="message {% if message.sender == current_user %}sent{% else %}received{% endif %}"
                         data-timestamp="{{ message.timestamp.isoformat }}">
                        <div class="message-text">{{ message.content }}</div>
                        <div class="message-time">{{ message.timestamp|date:"g:i A" }}</div>
                    </div>
                {% endfor %}
            </div>

            <div class="typing-indicator" id="typingIndicator" style="display: none;"></div>

            <div class="message-input-container">
                <input type="text" class="message-input" placeholder="Type a message..." id="messageInput">
                <button class="send-btn" id="sendBtn" title="Send message"></button>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}

    <script>
        const chatId = {{ chat.id }};
        const currentUser = '{{ current_user.username }}';
        const currentUserId = {{ current_user.id }};
        let chatSocket;
        let typingTimer;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // Update connection status
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');

            statusElement.className = `connection-status ${status}`;

            switch (status) {
                case 'connected':
                    statusElement.textContent = 'Connected';
                    statusElement.style.display = 'none';
                    sendBtn.disabled = false;
                    messageInput.disabled = false;
                    reconnectAttempts = 0;
                    break;
                case 'connecting':
                    statusElement.textContent = 'Connecting...';
                    statusElement.style.display = 'block';
                    sendBtn.disabled = true;
                    messageInput.disabled = true;
                    break;
                case 'disconnected':
                    statusElement.textContent = 'Disconnected - Trying to reconnect...';
                    statusElement.style.display = 'block';
                    sendBtn.disabled = true;
                    messageInput.disabled = true;
                    break;
            }
        }

        // Format timestamp to show correct time (5:49 format)
        function formatTimestamp(timestamp) {
            const messageTime = new Date(timestamp);
            return messageTime.toLocaleTimeString([], {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        // Update all message timestamps to show correct time
        function updateTimestamps() {
            const messages = document.querySelectorAll('.message[data-timestamp]');
            messages.forEach(message => {
                const timestamp = message.getAttribute('data-timestamp');
                const timeElement = message.querySelector('.message-time');
                if (timeElement && timestamp) {
                    timeElement.textContent = formatTimestamp(timestamp);
                }
            });
        }

        // Initialize WebSocket connection
        function initWebSocket() {
            updateConnectionStatus('connecting');

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/chat/${chatId}/`;

            chatSocket = new WebSocket(wsUrl);

            chatSocket.onopen = function (e) {
                console.log('WebSocket connection established');
                updateConnectionStatus('connected');
            };

            chatSocket.onmessage = function (e) {
                try {
                    const data = JSON.parse(e.data);

                    if (data.type === 'chat_message') {
                        addMessageToChat(data.message, data.sender, data.timestamp, data.sender_id);
                    } else if (data.type === 'typing_indicator') {
                        handleTypingIndicator(data.user, data.is_typing);
                    }
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };

            chatSocket.onclose = function (e) {
                console.log('WebSocket connection closed');
                updateConnectionStatus('disconnected');

                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(initWebSocket, 3000 * reconnectAttempts);
                }
            };

            chatSocket.onerror = function (e) {
                console.error('WebSocket error:', e);
                updateConnectionStatus('disconnected');
            };
        }

        // Add message to chat with correct timestamp
        function addMessageToChat(message, sender, timestamp, senderId) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            const isOwn = senderId === currentUserId;
            const now = new Date().toISOString();
            const currentTime = new Date().toLocaleTimeString([], {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            messageDiv.className = `message ${isOwn ? 'sent' : 'received'}`;
            messageDiv.setAttribute('data-timestamp', now);
            messageDiv.innerHTML = `
        <div class="message-text">${escapeHtml(message)}</div>
        <div class="message-time">${currentTime}</div>
    `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Send message
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            if (chatSocket.readyState !== WebSocket.OPEN) {
                alert('Connection lost. Please wait for reconnection.');
                return;
            }

            try {
                chatSocket.send(JSON.stringify({
                    'type': 'chat_message',
                    'message': message
                }));
                messageInput.value = '';

                // Stop typing indicator
                chatSocket.send(JSON.stringify({
                    'type': 'typing',
                    'is_typing': false
                }));

            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Handle typing indicator
        function handleTypingIndicator(user, isTyping) {
            const typingIndicator = document.getElementById('typingIndicator');

            if (isTyping) {
                typingIndicator.textContent = `${user} is typing...`;
                typingIndicator.style.display = 'block';
            } else {
                typingIndicator.style.display = 'none';
            }
        }

        // Send typing indicator
        function sendTypingIndicator(isTyping) {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                try {
                    chatSocket.send(JSON.stringify({
                        'type': 'typing',
                        'is_typing': isTyping
                    }));
                } catch (error) {
                    console.error('Error sending typing indicator:', error);
                }
            }
        }

        // Event listeners
        document.getElementById('sendBtn').addEventListener('click', sendMessage);

        document.getElementById('messageInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        // Typing indicator
        document.getElementById('messageInput').addEventListener('input', function () {
            sendTypingIndicator(true);

            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                sendTypingIndicator(false);
            }, 1000);
        });

        // Dropdown functionality
        let dropdownVisible = false;

        function toggleChatDropdown() {
            const menu = document.getElementById('chatDropdownMenu');
            const toggleBtn = document.getElementById('dropdownToggleBtn');

            if (!menu) {
                console.error('Chat dropdown menu element not found');
                return;
            }

            dropdownVisible = !dropdownVisible;

            if (dropdownVisible) {
                menu.classList.add('show');
                toggleBtn.style.background = 'rgba(255,255,255,0.2)';
            } else {
                menu.classList.remove('show');
                toggleBtn.style.background = 'transparent';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function () {
            initWebSocket();

            // Scroll to bottom
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Update all existing timestamps to show correct format
            updateTimestamps();

            // Setup dropdown functionality
            const dropdownToggleBtn = document.getElementById('dropdownToggleBtn');
            if (dropdownToggleBtn) {
                dropdownToggleBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleChatDropdown();
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                const menu = document.getElementById('chatDropdownMenu');
                const toggleBtn = document.getElementById('dropdownToggleBtn');

                if (menu && toggleBtn && !menu.contains(e.target) && !toggleBtn.contains(e.target) && dropdownVisible) {
                    menu.classList.remove('show');
                    toggleBtn.style.background = 'transparent';
                    dropdownVisible = false;
                }
            });

            // Close dropdown with Escape key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && dropdownVisible) {
                    const menu = document.getElementById('chatDropdownMenu');
                    const toggleBtn = document.getElementById('dropdownToggleBtn');
                    if (menu) {
                        menu.classList.remove('show');
                        toggleBtn.style.background = 'transparent';
                        dropdownVisible = false;
                    }
                }
            });
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', function () {
            if (chatSocket) {
                chatSocket.close();
            }
        });

        // User search in contact list
        document.getElementById('searchInput').addEventListener('input', function () {
            const query = this.value.trim();
            const resultsDiv = document.getElementById('searchResults');

            if (query.length > 0) {
                fetch(`/api/search-users/?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        resultsDiv.innerHTML = '';

                        if (data.users.length > 0) {
                            data.users.forEach(user => {
                                const userDiv = document.createElement('div');
                                userDiv.style.cssText = 'display: flex; align-items: center; padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: var(--transition);';

                                const colors = [
                                    "linear-gradient(135deg, #ff6b6b, #ee5a24)",
                                    "linear-gradient(135deg, #a29bfe, #6c5ce7)",
                                    "linear-gradient(135deg, #fd79a8, #e84393)",
                                    "linear-gradient(135deg, #fdcb6e, #e17055)",
                                    "linear-gradient(135deg, #74b9ff, #0984e3)",
                                    "linear-gradient(135deg, #55a3ff, #3742fa)",
                                    "linear-gradient(135deg, #26de81, #20bf6b)",
                                    "linear-gradient(135deg, #f7b731, #fa8231)",
                                ];
                                const avatarColor = colors[user.id % colors.length];

                                userDiv.innerHTML = `
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${avatarColor}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; margin-right: 12px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 14px;">
                                ${user.initials}
                                ${user.is_online ? '<div style="width: 12px; height: 12px; background-color: var(--secondary-color); border-radius: 50%; border: 2px solid white; position: absolute; bottom: 0; right: 0;"></div>' : ''}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 2px; font-size: 13px;">${user.full_name}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">@${user.username} ${user.is_online ? '• <span style="color: var(--secondary-color);">Online</span>' : ''}</div>
                            </div>
                        `;

                                userDiv.addEventListener('mouseenter', () => {
                                    userDiv.style.backgroundColor = 'var(--hover-color)';
                                });
                                userDiv.addEventListener('mouseleave', () => {
                                    userDiv.style.backgroundColor = 'transparent';
                                });
                                userDiv.addEventListener('click', () => {
                                    window.location.href = `/start-chat/${user.id}/`;
                                });

                                resultsDiv.appendChild(userDiv);
                            });
                            resultsDiv.style.display = 'block';
                        } else {
                            resultsDiv.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-secondary); font-size: 12px;">No users found</div>';
                            resultsDiv.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Search error:', error);
                        resultsDiv.innerHTML = '<div style="padding: 24px; text-align: center; color: #ff6b6b; font-size: 12px;">Search failed. Please try again.</div>';
                        resultsDiv.style.display = 'block';
                    });
            } else {
                resultsDiv.style.display = 'none';
            }
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function (e) {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');

            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        // -- Message Search bar--
        document.getElementById('chatSearchInput').addEventListener('input', function () {
            const query = this.value.trim().toLowerCase();
            const resultsDiv = document.getElementById('chatSearchResults');
            const messages = document.querySelectorAll('.message');
            resultsDiv.innerHTML = '';

            if (query.length > 0) {
                let matchingMessages = [];
                messages.forEach((message, index) => {
                    const messageText = message.querySelector('.message-text');
                    const messageTime = message.querySelector('.message-time');
                    if (messageText && messageText.textContent.toLowerCase().includes(query)) {
                        matchingMessages.push({
                            txt: messageText.textContent,
                            time: messageTime ? messageTime.textContent : '',
                            el: message,
                            idx: index
                        });
                    }
                });

                if (matchingMessages.length > 0) {
                    matchingMessages.slice(0, 5).forEach(match => {
                        const div = document.createElement('div');
                        div.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start; padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: var(--transition); background: transparent;';
                        // highlight query
                        const txtMarked = match.txt.replace(new RegExp(query, "gi"),
                            str => `<mark style="background: #ffeb3b; padding: 1px 2px; border-radius: 2px;">${str}</mark>`);
                        div.innerHTML = `
                        <div style="font-size: 13px; color: var(--text-primary); margin-bottom: 3px; font-weight: 500;">${txtMarked}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">${match.time}</div>
                    `;
                        div.addEventListener('mouseenter', () => {
                            div.style.backgroundColor = 'var(--hover-color)';
                        });
                        div.addEventListener('mouseleave', () => {
                            div.style.backgroundColor = 'transparent';
                        });
                        div.addEventListener('click', () => {
                            match.el.scrollIntoView({behavior: 'smooth', block: 'center'});
                            match.el.style.backgroundColor = '#fff3cd';
                            setTimeout(() => {
                                match.el.style.backgroundColor = '';
                            }, 1500);
                            resultsDiv.style.display = 'none';
                            document.getElementById('chatSearchInput').value = '';
                        });
                        resultsDiv.appendChild(div);
                    });
                    if (matchingMessages.length > 5) {
                        const moreDiv = document.createElement('div');
                        moreDiv.style.cssText = 'padding: 8px 12px; text-align: center; color: var(--text-secondary); font-size: 11px; font-style: italic;';
                        moreDiv.textContent = `+${matchingMessages.length - 5} more results`;
                        resultsDiv.appendChild(moreDiv);
                    }
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-secondary); font-size: 12px;">No messages found</div>';
                    resultsDiv.style.display = 'block';
                }
            } else {
                resultsDiv.style.display = 'none';
            }
        });

        // Hide chat search results when clicking outside
        document.addEventListener('click', function (e) {
            const chatSearchInput = document.getElementById('chatSearchInput');
            const chatSearchResults = document.getElementById('chatSearchResults');
            if (!chatSearchInput.contains(e.target) && !chatSearchResults.contains(e.target)) {
                chatSearchResults.style.display = 'none';
            }
        });

        // Clear search when pressing Escape
        document.getElementById('chatSearchInput').addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                this.value = '';
                document.getElementById('chatSearchResults').style.display = 'none';
            }
        });

        // For Dropdoen button
        let userMenuVisible = false;

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            const menuBtn = document.getElementById('menuBtn');

            if (!menu) {
                console.error('Menu element not found');
                return;
            }

            userMenuVisible = !userMenuVisible;

            if (userMenuVisible) {
                menu.classList.add('show');
                menuBtn.style.background = 'rgba(255,255,255,0.2)';
            } else {
                menu.classList.remove('show');
                menuBtn.style.background = 'transparent';
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing menu');

            // Ensure menu button works
            const menuBtn = document.getElementById('menuBtn');
            if (menuBtn) {
                menuBtn.addEventListener('click', function (e) {
                    console.log('clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    toggleUserMenu();
                    userMenu.classList.toggle("show");
                });
            }

            // Close menu when clicking outside
            document.addEventListener('click', function (e) {
                const menu = document.getElementById('userMenu');
                const menuBtn = document.getElementById('menuBtn');

                if (menu && menuBtn && !menu.contains(e.target) && !menuBtn.contains(e.target) && userMenuVisible) {
                    menu.classList.remove('show');
                    menuBtn.style.background = 'transparent';
                    userMenuVisible = false;
                }
            });

            // Close menu with Escape key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && userMenuVisible) {
                    const menu = document.getElementById('userMenu');
                    const menuBtn = document.getElementById('menuBtn');
                    if (menu) {
                        menu.classList.remove('show');
                        menuBtn.style.background = 'transparent';
                        userMenuVisible = false;
                    }
                }
            });
        });

    </script>
{% endblock %}
