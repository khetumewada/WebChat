{% extends 'base.html' %}
{% block title %}Forgot Password - WebChat{% endblock %}

{% block content %}
<div class="auth-container">
    {# EMAIL FORM: Shown when not show_reset_form and not status=='done' #}
    {% if not show_reset_form and status != "done" %}
    <form method="post" action="{% url 'account:password_reset' %}" class="auth-form" autocomplete="on" style="max-width: 370px; margin: 0 auto;">
        {% csrf_token %}
        <div style="text-align: center; margin-bottom: 32px;">
            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #00a884, #25d366); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; margin: 0 auto 16px; box-shadow: 0 4px 16px rgba(0, 168, 132, 0.3);">
                ðŸ”‘
            </div>
            <h2>Forgot Password</h2>
            <p style="color: #667781; margin-top: 8px; font-size: 13px;">
                Enter your email to reset your password
            </p>
        </div>
        {% if status == "sent" %}
            <div class="success-message"
                 style="margin-bottom:20px;display:flex;align-items:center;justify-content:center;gap:12px; background:#e4f8ee; border: 1.5px solid #25a869; color:#178554; font-size:15px; padding:14px 12px; border-radius:6px;">
                <span style="font-size:22px;">ðŸ“§</span>
                <span>A reset link has been sent to <strong>{{ email }}</strong>.</span>
            </div>
        {% elif status == "no_user" %}
            <div class="error-message"
                 style="margin-bottom:20px;text-align:center;color:#d32f2f;font-size:15px;padding:14px 10px;background:#fceaea;border-radius:6px;">
                No user found with email <strong>{{ email }}</strong>.
            </div>
        {% endif %}
        <div class="form-group">
            <label for="forgot-email">Email</label>
            <input
                type="email"
                id="forgot-email"
                name="email"
                required
                placeholder="you@example.com"
                class="form-input"
                value="{{ email|default:'' }}"
                {% if status == "sent" %}readonly{% endif %}>
        </div>
        <button type="submit" class="btn-primary"
                style="width:100%;" {% if status == "sent" %}disabled{% endif %}>
            {% if status == "sent" %}
                Sent!
            {% else %}
                Send Reset Link
            {% endif %}
        </button>
        <div class="auth-links" style="text-align:center;margin-top:14px;">
            <a href="{% url 'account:login' %}" style="color:#007bff;font-size:13px;">Back to sign in</a>
        </div>
    </form>
    {% endif %}

    {# NEW PASSWORD FORM: Shown after clicking the link in email #}
    {% if show_reset_form and status != "done" %}
    <form method="post" action="{% url 'account:password_reset' %}" class="auth-form" style="max-width: 370px; margin: 0 auto;">
        {% csrf_token %}
        <input type="hidden" name="step" value="reset" />
        <input type="hidden" name="uid" value="{{ uid }}">
        <input type="hidden" name="token" value="{{ token }}">
        <div style="text-align: center; margin-bottom: 32px;">
            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #00a884, #25d366); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; margin: 0 auto 16px; box-shadow: 0 4px 16px rgba(0, 168, 132, 0.3);">
                ðŸ”’
            </div>
            <h2>Reset Your Password</h2>
            <p style="color: #667781; margin-top: 8px; font-size: 13px;">
                Set a new password for your account
            </p>
        </div>
        {% if status == "pw_mismatch" %}
            <div class="error-message"
                 style="margin-bottom:20px;text-align:center;color:#d32f2f;font-size:15px;padding:14px 10px;background:#fceaea;border-radius:6px;">
                The passwords do not match or are too short (min 6 characters).
            </div>
        {% elif status == "invalid" %}
            <div class="error-message"
                 style="margin-bottom:20px;text-align:center;color:#d32f2f;font-size:15px;padding:14px 10px;background:#fceaea;border-radius:6px;">
                This reset link is invalid or expired.
            </div>
        {% endif %}
        <div class="form-group">
            <label for="new-password1">New Password</label>
            <input
                type="password"
                id="new-password1"
                name="new_password1"
                required
                minlength="6"
                placeholder="Enter a new password"
                class="form-input"
            >
        </div>
        <div class="form-group">
            <label for="new-password2">Confirm New Password</label>
            <input
                type="password"
                id="new-password2"
                name="new_password2"
                required
                minlength="6"
                placeholder="Confirm new password"
                class="form-input"
            >
        </div>
        <button type="submit" class="btn-primary" style="width:100%;">Reset Password</button>
        <div class="auth-links" style="text-align:center;margin-top:14px;">
            <a href="{% url 'account:login' %}" style="color:#007bff;font-size:13px;">Back to sign in</a>
        </div>
    </form>
    {% endif %}

    {# SUCCESS MESSAGE after password is reset #}
    {% if status == "done" %}
    <div class="auth-form" style="max-width: 370px; text-align: center; margin: 0 auto;">
        <div style="width: 64px; height: 64px; background: linear-gradient(135deg,#094ee2,#25d366); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; color: white; margin: 0 auto 25px; box-shadow: 0 4px 16px rgba(9,78,226,0.17);">
            ðŸŽ‰
        </div>
        <h2>Password Changed</h2>
        <div class="success-message"
             style="color: #1246a3; background:#e7f2ff; font-size: 16px; margin-bottom: 24px; padding:16px 10px; border: 1.5px solid #246fd3; border-radius: 7px;">
            Your password has been reset.<br>
            You can now log in with your new password.
        </div>
        <a href="{% url 'account:login' %}" class="btn-primary"
           style="width:100%;display:inline-block;text-align:center;text-decoration:none;">Sign In</a>
    </div>
    {% endif %}
</div>
{% endblock %}
